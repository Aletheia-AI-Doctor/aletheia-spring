package dev.aletheia.doctor.controller;import dev.aletheia.doctor.dtos.auth.SignInDto;import dev.aletheia.doctor.dtos.doctors.DoctorRegistrationDTO;import dev.aletheia.doctor.emailservice.AleithiaEmailAuthentication;import dev.aletheia.doctor.exceptions.InvalidCredentialsException;import dev.aletheia.doctor.models.Doctor;import dev.aletheia.doctor.services.DoctorService;import dev.aletheia.doctor.services.JWTService;import jakarta.servlet.http.HttpServletResponse;import lombok.Value;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.web.bind.annotation.*;import java.io.IOException;import java.net.URI;import java.util.Map;import java.util.UUID;@RestControllerpublic class AuthenticationController {    private final DoctorService doctorService;    private final AleithiaEmailAuthentication emailService;    private final JWTService jwtService;    public AuthenticationController(DoctorService doctorService, AleithiaEmailAuthentication emailService, JWTService jwtService) {        this.doctorService = doctorService;        this.emailService = emailService;        this.jwtService = jwtService;    }    @PostMapping("/api/login")    public ResponseEntity<Object> signIn(@RequestBody SignInDto signInDto) {        Doctor doctor = doctorService.getByIdentifier(signInDto.getEmail())                .orElseThrow(InvalidCredentialsException::new);        if (!doctor.checkPassword(signInDto.getPassword())) {            throw new InvalidCredentialsException();        }        if (!doctor.isConfirmed()) {            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(Map.of(                    "message", "Please confirm your email address before logging in",                    "success", false            ));        }        return ResponseEntity.ok(Map.of(                        "message", "Login successful",                        "token", jwtService.generateToken(doctor),                        "doctor", doctorService.convertToDto(doctor)                )        );    }    @PostMapping("/api/register")    public ResponseEntity<Object> create(@RequestBody DoctorRegistrationDTO doctorDTO) {        Doctor doctor = doctorService.createDoctor(doctorDTO);        String confirmationToken = UUID.randomUUID().toString();        String confirmationUrl = "http://localhost:8080/api/confirm-email/" + doctor.getId()+ "?token=" + confirmationToken;        doctorService.saveConfirmationToken(doctor.getId(), confirmationToken);        emailService.sendConfirmationRequest(                doctor.getHospital().getHr_email(),                doctor.getName(),                doctor.getSpeciality().toString(),                doctor.getLicenseNumber(),                confirmationUrl        );        return ResponseEntity.ok(Map.of(                "message", "Registration successful! Please check your email for confirmation instructions.",                "doctor", doctorService.convertToDto(doctor),                "success", true        ));    }    @GetMapping("/api/confirm-email/{doctorId}")    public ResponseEntity<Object> confirmEmail(@PathVariable Long doctorId, @RequestParam String token, HttpServletResponse response) throws IOException {        boolean confirmed = doctorService.confirmDoctor(token);        String frontendConfirmUrl = "http://localhost:3000/confirm-email"; // Adjust to your frontend URL        if (confirmed) {            Doctor doctor = doctorService.findByConfirmationToken(token)                    .orElseThrow(() -> new RuntimeException("Doctor not found"));            doctor.setConfirmed(true);            String loginURL = "http://localhost:8080/api/login";            emailService.sendConfirmationDoctor(                    doctor.getEmail(),                    doctor.getName(),                    doctor.getHospital().getName(),                    loginURL            );            // Redirect to frontend with success status            response.sendRedirect("http://localhost:3000/confirm-email?status=success");            return null;        } else {            // Redirect to frontend with error status            return ResponseEntity.status(HttpStatus.FOUND)                    .location(URI.create(frontendConfirmUrl + "?success=false"))                    .build();        }    }}